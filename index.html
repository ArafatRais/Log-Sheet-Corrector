<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Entry Corrector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container {
            max-width: 900px;
        }
        /* Custom styles for the textarea and results */
        textarea, .result-box {
            border: 2px solid #e5e7eb;
            transition: all 0.2s;
        }
        textarea:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="container mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">Daily Log Entry Corrector</h1>
            <p class="text-gray-500">Paste your log sheet entry below to instantly fix grammatical and structural errors.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Input Card -->
            <div class="bg-white p-6 rounded-xl shadow-lg h-full flex flex-col">
                <h2 class="text-xl font-semibold text-indigo-600 mb-4">1. Paste Original Entry</h2>
                <textarea id="logInput"
                          class="w-full flex-grow p-4 rounded-lg text-gray-700 focus:outline-none resize-none"
                          rows="10"
                          placeholder="Example: 15/05/26, The child woke up late and he refuse to eat breakfast. He went school at 9:30am. I asked him why he angry. He had snack but no dinner at home."></textarea>
                
                <button onclick="correctEntry()" id="correctButton"
                        class="mt-6 w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out disabled:bg-indigo-400">
                    Fix & Format Entry
                </button>
            </div>

            <!-- Output Card -->
            <div class="bg-white p-6 rounded-xl shadow-lg h-full flex flex-col">
                <h2 class="text-xl font-semibold text-green-600 mb-4">2. Corrected & Formatted Result</h2>
                
                <div id="loadingIndicator" class="hidden text-center py-10">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-3"></div>
                    <p class="text-indigo-600 font-medium">Processing correction...</p>
                </div>

                <div id="resultContainer" class="flex-grow">
                    <textarea readonly id="logOutput"
                              class="result-box w-full h-full p-4 rounded-lg bg-gray-50 text-gray-800 resize-none min-h-[200px]"
                              placeholder="Your corrected log entry will appear here."></textarea>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_KEY = ""; // Leave this as-is
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;

        const inputEl = document.getElementById('logInput');
        const outputEl = document.getElementById('logOutput');
        const correctButton = document.getElementById('correctButton');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // Function to perform exponential backoff retry for fetch
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429) {
                        // Too many requests, retry after delay
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API call failed: ${response.status} - ${errorData.error?.message || response.statusText}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) throw error; // Re-throw on last attempt
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function correctEntry() {
            const originalEntry = inputEl.value.trim();

            if (!originalEntry) {
                outputEl.value = "Please paste a log entry to correct.";
                return;
            }

            // UI feedback
            correctButton.disabled = true;
            correctButton.textContent = 'Processing...';
            outputEl.value = '';
            loadingIndicator.classList.remove('hidden');

            const systemInstruction = `You are an expert log sheet editor. Your task is to take a single, raw, daily log entry and perform the following corrections:
1. Fix all grammatical, punctuation, and spelling errors.
2. Improve sentence structure and flow for clarity, while keeping the language simple and direct.
3. Ensure all names (like 'A' or 'M') are consistently capitalized and used correctly. For generic examples like 'The child' or 'The young person', maintain that general phrasing.
4. Convert time formats (like '4:30pm' or '1pm') to the standard, spaced format (e.g., '4:30 pm' or '1 pm').
5. Preserve all original details and content, including dates, times, and observations about behavior, meals, or events.
6. **The final output must be JUST the corrected text, with NO conversational filler, introduction, or markdown formatting (no bolding, no asterisks, no quotes, etc.).**`;

            const userQuery = `Correct and clean up this log entry: "${originalEntry}"`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                },
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                const correctedText = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "Error: Could not retrieve a corrected entry.";
                
                outputEl.value = correctedText;

            } catch (error) {
                console.error("Gemini API Error:", error);
                outputEl.value = `An error occurred while communicating with the API. Please try again. (${error.message})`;
            } finally {
                // UI cleanup
                correctButton.disabled = false;
                correctButton.textContent = 'Fix & Format Entry';
                loadingIndicator.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
